This page is now out of date
============================

This tutorial will show you how to, from scratch: create a VM with a very simple script which will download public data from the CADC archive, process it with SExtractor and store the results into your VOSpace. For more details on to each step described in this tutorial, refer to the [In Depth Configuration](In Depth Configuration "wikilink") to configure a VM, the [In Depth Processing](In Depth Processing "wikilink") to submit jobs, and [In Depth VOSpace](In Depth VOSpace "wikilink") for storage configuration. We assume here you have the following account activated: a CANFAR account, a CADC account, and you have a VOSpace account.

First, log on to the CANFAR login host:

    ssh canfar.dao.nrc.ca

From there, launch the VM manager tool:

    /usr/cadc/local/scripts/vcetool

Within the vcetool, create a minimal VM, which we will name "demo":

    create demo

Wait..... for the dots to go by. This step can take up to 5 minutes. Copy the returned IP address on to the juset created VM:

    ssh <IP address>

We now turn into software installation on the VM. Let's start with SExtractor:

    cd $HOME
    wget ftp://ftp.iap.fr/pub/from_users/bertin/sextractor/sextractor-2.8.6.tar.gz
    tar xf sextractor-2.8.6.tar.gz
    cd sextractor-2.8.6
    ./configure

As you see, it fails on missing fftw, and later on ATLAS dependencies. Fortunately they have been packaged, so install them with the following command:

    sudo yum install fftw-devel atlas-devel

Then finish up your SExtractor installation:

    ./configure
    make
    sudo make install

We also need the "funpack" executable from CFITSIO to uncompress data downloaded from the CADC:

    cd $HOME
    wget http://heasarc.gsfc.nasa.gov/fitsio/fpack/bin/pc_linux_64bit/funpack 
    sudo mv funpack /usr/local/bn

The last bit of software is the VOSpace command line client that we need to upload the catalogues generated by SExtractor.

    cd $HOME
    wget http://www.cadc-ccda.hia-iha.nrc-cnrc.gc.ca/cadcVOS/software/cadcVOSClient.tar
    tar -xvf cadcVOSClient.tar

It's now installed in \$HOME/lib. Now you need a certificate. Download it with wget and have it valid for two days:

    cd $HOME
    mkdir .ssl
    wget --http-user=<CADC_username> \
         --http-password=<CADC_password> \
         -O ~/.ssl/cadcproxy.pem \
         'http://www.cadc-ccda.hia-iha.nrc-cnrc.gc.ca/cred/proxyCert?daysValid=2'

Make some scratch space to work on:

    sudo mount -t ext2 /dev/sda1 /staging
    sudo chown <username>:<username> /staging

Download a FITS image, uncompress it and run SExtractor on it:

    cd /staging
    cp -r $HOME/sextractor-2.8.6/config/default* .
    wget -O 1056213p.fits.fz \
          'http://www.cadc.hia.nrc.gc.ca/getData?archive=CFHT&asf=true&file_id=1056213p'
    funpack 1056213p.fits.fz
    sex 1056213p.fits -CATALOG_NAME 1056213p.cat 

Check your VOSpace client works by copying the SExtractor results to your VOSpace:

    java -jar $HOME/lib/cadcVOSClient.jar \
         --copy --src=1056213p.cat \
         --dest=vos://cadc.nrc.ca~vospace/<your VOspaceID>/1056213p.cat

Verify that the file is properly uploaded by pointing your browser to the VOSpace web interface at [<http://www.cadc-ccda.hia-iha.nrc-cnrc.gc.ca/vosui/>](http://www.cadc-ccda.hia-iha.nrc-cnrc.gc.ca/vosui/) (The interface will automatically add \#yourVOspaceID to the URL).

Now you need to automate the whole procedure above in a single script. One possible script is:

    #!/bin/bash
    cd ${TMPDIR:-/staging}
    wget -q -O ${1}.fits.fz 'http://www.cadc.hia.nrc.gc.ca/getData?archive=CFHT&asf=true&file_id='${1}
    funpack  ${1}.fits.fz
    cp ~/sextractor-2.8.6/config/default.* .
    sex $1.fits -CATALOG_NAME $1.cat -VERBOSE_TYPE QUIET
    java -jar ~/canfar/lib/cadcVOSClient.jar --copy \
         --src=${1}.cat --dest=vos://cadc.nrc.ca~vospace/sgwyn/demo/${1}.cat

This script runs all the commands, one after the other, and \${1} represents the file ID on the CADC CFHT archive and is the only argument the scrtipt takes. Note the difference between the commands in this script and the earlier commands: -q in the wget command to make it more quiet, -VERBOSE\_TYPE QUIET in the SExtractor command, This is to avoid a lot of stuff in the output logs. We also use the environment variable \${TMPDIR} for condor, and is defaulted to /staging when not defined during your live VM sessions. Save your script which we will name "sexdemo.bash" and set it as executable:

    chmod +x sexdemo.bash

Now test your newly created script with a different file ID:

    sexdemo.bash 1056214p

Just as during the manual testing, verify the output, and the upload with the VOSpace web interface on that the catalogue has been uploaded. Is everything OK? Rename your VM as something meaningful by replacing the "canfarbase" value of the VMType parameter in the file /etc/condor/condor\_config.local. We will call the VM here as "sexdemo". Edit it with sudo because /etc/condor/condor\_config.local is stored as root:

    sudo emacs /etc/condor/condor_config.local

Save the file, exit the editor. Go back to the CANFAR login host:

    exit

On the CANFAR login host, copy over your sexdemo.bash script:

    scp <VM_IP>:sexdemo.bash .

Finally, go back on your VM, and shutdown your configuration session, it will also save the VM:

    ssh <VM_IP>
    sudo /sbin/shutdown -h now

You are done for the configuration part. Now make a condor submission script that will run the wrapper script for each given CADC CFHT file id. We will do it for 3 CFHT images with the file ids 1056215p, 1056216p and 1056217p. Fire up your favorite editor

Save the script as "sexdemo.sub"and submit your script to the condor pool:

    condor_submit sexdemo.sub

Count the dots, there should be 3. Wait a couple minutes. See where do your jobs stand on the queue:

    condor_q

Check the status of your jobs:

    condor_status

Monitor the sexdemo.log, sexdemo.err, sexdemo.out files. Once you have no more jobs on the queue, check the log/output files again, and check on your VOSpace browser all the 3 generated catalogues have been uploaded.

You are done!
